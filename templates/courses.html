<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <title>üìö –ö—É—Ä—Å—Ç–∞—Ä</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    select, input, textarea, button {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      border-radius: 6px;
    }
    button {
      background: #7bed9f;
      color: black;
      border: none;
      cursor: pointer;
    }
    #courseForm, .course-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .course-card {
  width: 300px;
  height: auto; /* –±“±—Ä—ã–Ω 300px –±–æ–ª–¥—ã, –∞—É—ã—Å—Ç—ã—Ä–¥—ã“õ */
  display: inline-block;
  vertical-align: top;
  margin: 10px;
  overflow: hidden;
  position: relative;
  cursor: pointer;
  padding-bottom: 60px; /* –±–∞—Ç—ã—Ä–º–∞–ª–∞—Ä “Ø—à—ñ–Ω –æ—Ä—ã–Ω “õ–∞–ª–¥—ã—Ä–∞–¥—ã */
  box-sizing: border-box;
}
    .course-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 6px;
    }
    .course-card h3 {
  margin: 10px 0 5px;
  font-size: 18px;
}

.course-card p {
  font-size: 14px;
  height: 42px; /* 2 –∂–æ–ª —à–∞–º–∞–º–µ–Ω */
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}
.course-actions {
  position: absolute;
  bottom: 10px;
  left: 10px;
  right: 10px;
  display: flex;
  justify-content: space-between;
}
    .course-actions button {
      margin-right: 10px;
      padding: 5px 10px;
      font-size: 13px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .edit-btn {
      background: #28a745;
      color: white;
    }
    .delete-btn {
      background: #dc3545;
      color: white;
    }
    #courseModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #courseModal .modal-content {
  background: white;
  padding: 20px;
  border-radius: 10px;
  max-width: 600px;
  width: 90%;
  position: relative;
  max-height: 90vh;
  overflow-y: auto; /* ‚¨ÖÔ∏è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ “õ–æ—Å—ã–ª–¥—ã */
}
    #closeModal {
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      font-size: 24px;
    }

    #modalVideo {
  margin-top: 15px;
  max-width: 100%;
  height: 315px;
}
.back-btn {
  position: fixed;
  top: 40px;
  right: 40px;
  background-color: #7bed9f;
  color: black;
  padding: 8px 12px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: bold;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  transition: background-color 0.2s ease;
  z-index: 1000;
}
.back-btn:hover {
  background-color: #2ecc71;
  color: white;
}
.background-figures {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
            pointer-events: none;
        }

        .shape {
            position: absolute;
            opacity: 0.3;
            animation: float 20s infinite ease-in-out;
        }

        .circle {
            background: #66ccff;
            width: 120px;
            height: 120px;
            top: 10%;
            left: 20%;
            border-radius: 50%;
        }

        .square {
            background: #ff99cc;
            width: 100px;
            height: 100px;
            top: 40%;
            left: 70%;
        }

        .triangle {
            width: 0;
            height: 0;
            border-left: 60px solid transparent;
            border-right: 60px solid transparent;
            border-bottom: 100px solid #99ff99;
            top: 70%;
            left: 10%;
            position: absolute;
            opacity: 0.3;
            animation: float 25s infinite ease-in-out;
        }

        .oval {
            background: #ffcc66;
            width: 160px;
            height: 80px;
            top: 20%;
            left: 50%;
            border-radius: 50% / 25%;
            transform: rotate(25deg);
        }

        .blob {
            background: #cc99ff;
            width: 140px;
            height: 140px;
            top: 60%;
            left: 35%;
            border-radius: 50% 30% 50% 30%;
        }

        .diamond {
            background: #99cc66;
            width: 80px;
            height: 80px;
            top: 36%;
            left: 10%;
            transform: rotate(45deg);
        }

        .semicircle {
            width: 100px;
            height: 50px;
            background: #ff6666;
            top: 80%;
            left: 60%;
            border-top-left-radius: 100px;
            border-top-right-radius: 100px;
        }

        .star {
            width: 0;
            height: 0;
            top: 80%;
            left: 70%;
            position: absolute;
            background: transparent;
            clip-path: polygon(
                50% 0%,
                61% 35%,
                98% 35%,
                68% 57%,
                79% 91%,
                50% 70%,
                21% 91%,
                32% 57%,
                2% 35%,
                39% 35%
            );
            background-color: #00cccc;
        }

        .hexagon {
            width: 100px;
            height: 55px;
            background: #ccff99;
            top: 15%;
            left: 75%;
            position: absolute;
            clip-path: polygon(
                50% 0%,
                100% 25%,
                100% 75%,
                50% 100%,
                0% 75%,
                0% 25%
            );
        }

        .wavy {
            width: 100px;
            height: 100px;
            background: repeating-radial-gradient(circle at center, #ffb3b3, #ffb3b3 10px, transparent 10px, transparent 20px);
            border-radius: 50%;
            top: 75%;
            left: 85%;
        }

        @keyframes float {
            0% {
                transform: translateY(0) scale(1);
            }
            50% {
                transform: translateY(-20px) scale(1.05);
            }
            100% {
                transform: translateY(0) scale(1);
            }
        }

        .image-container {
            max-width: 55%;
            margin-top: -660px;
            float: right;
            margin-right: 100px; /* —É–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è */
        }

        .image-container img {
            width: 100%;
        }
  </style>
</head>
<body>
<a href="/base/" class="back-btn">üîô –ë–∞—Å—Ç—ã –±–µ—Ç–∫–µ</a>
<h1 id="pageTitle">üìö –ö—É—Ä—Å—Ç–∞—Ä</h1>

<select id="languageSelect">
  <option value="kk">“ö–∞–∑–∞“õ—à–∞</option>
  <option value="ru">–†—É—Å—Å–∫–∏–π</option>
  <option value="en">English</option>
</select>

<button id="addCourseBtn" style="display:none;">–ö—É—Ä—Å “õ–æ—Å—É</button>

<form id="courseForm" style="display:none;" data-edit-id="">
  <input type="text" id="courseTitle" placeholder="–ö—É—Ä—Å —Ç–∞“õ—ã—Ä—ã–±—ã / –ù–∞–∑–≤–∞–Ω–∏–µ / Title" required>
  <textarea id="courseDescription" placeholder="–°–∏–ø–∞—Ç—Ç–∞–º–∞ / Description / –û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
  <input type="text" id="courseImage" placeholder="Image URL / –°—É—Ä–µ—Ç —Å—ñ–ª—Ç–µ–º–µ—Å—ñ">
  <input type="text" id="courseVideo" placeholder="Video URL / –í–∏–¥–µ–æ —Å—ñ–ª—Ç–µ–º–µ—Å—ñ">
  <button type="submit">“ö–æ—Å—É / Add / –î–æ–±–∞–≤–∏—Ç—å</button>
</form>
<div class="background-figures">
  <div class="shape circle"></div>
  <div class="shape square"></div>
  <div class="triangle"></div>
  <div class="shape oval"></div>
  <div class="shape blob"></div>
  <div class="shape diamond"></div>
  <div class="shape semicircle"></div>
  <div class="star"></div>
  <div class="hexagon"></div>
  <div class="shape wavy"></div>
</div>
<div id="coursesList"></div>

<!-- Modal -->
<div id="courseModal">
  <div class="modal-content">
    <span id="closeModal">&times;</span>
    <h2 id="modalTitle"></h2>
    <p id="modalDescription"></p>
    <img id="modalImage" src="" alt="Course Image" style="max-width:100%; border-radius:6px; margin-top:10px;">
    <iframe id="modalVideo" width="100%" height="315" frameborder="0" allowfullscreen style="margin-top:15px;"></iframe>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAClsdr7MwNndWFc7_L-BlZRNLeMjsxxxQ",
    authDomain: "edication-ce7a0.firebaseapp.com",
    projectId: "edication-ce7a0",
    storageBucket: "edication-ce7a0.appspot.com",
    messagingSenderId: "336523450386",
    appId: "1:336523450386:web:c63104c263520f594c60cb",
    measurementId: "G-GLKBYPXMPC"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const addCourseBtn = document.getElementById('addCourseBtn');
  const courseForm = document.getElementById('courseForm');
  const coursesList = document.getElementById('coursesList');
  const pageTitle = document.getElementById('pageTitle');
  const langSelect = document.getElementById('languageSelect');

  const texts = {
    kk: { title: 'üìö –ö—É—Ä—Å—Ç–∞—Ä', add: '–ö—É—Ä—Å “õ–æ—Å—É', submit: '“ö–æ—Å—É', edit: '”®–∑–≥–µ—Ä—Ç—É', del: '–ñ–æ—é' },
    ru: { title: 'üìö –ö—É—Ä—Å—ã', add: '–î–æ–±–∞–≤–∏—Ç—å –∫—É—Ä—Å', submit: '–î–æ–±–∞–≤–∏—Ç—å', edit: '–ò–∑–º–µ–Ω–∏—Ç—å', del: '–£–¥–∞–ª–∏—Ç—å' },
    en: { title: 'üìö Courses', add: 'Add Course', submit: 'Submit', edit: 'Edit', del: 'Delete' }
  };

  let currentLang = localStorage.getItem('lang') || 'kk';
  let currentUser = null;
  let currentUserRole = null;

  function applyLang() {
    const t = texts[currentLang];
    pageTitle.textContent = t.title;
    addCourseBtn.textContent = t.add;
    courseForm.querySelector('button').textContent = t.submit;
    langSelect.value = currentLang;
    loadCourses();
  }

  langSelect.addEventListener('change', e => {
    currentLang = e.target.value;
    localStorage.setItem('lang', currentLang);
    applyLang();
  });

  applyLang();

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      const snap = await getDocs(collection(db, 'users'));
      snap.forEach(doc => {
        if (doc.data().uid === currentUser.uid) {
          currentUserRole = doc.data().role;
        }
      });

      if (currentUserRole === 'teacher') {
        addCourseBtn.style.display = 'block';
      }

      loadCourses();
    }
  });

  addCourseBtn.addEventListener('click', () => {
    courseForm.reset();
    courseForm.dataset.editId = "";
    courseForm.style.display = courseForm.style.display === 'none' ? 'block' : 'none';
  });

  courseForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const title = document.getElementById('courseTitle').value;
    const description = document.getElementById('courseDescription').value;
    const image = document.getElementById('courseImage').value;
    const video = document.getElementById('courseVideo').value;

    const course = {
      title, description, image, video,
      lang: currentLang,
      uid: currentUser.uid,
      createdAt: new Date()
    };

    const editId = courseForm.dataset.editId;
    if (editId) {
      await updateDoc(doc(db, 'courses', editId), course);
    } else {
      await addDoc(collection(db, 'courses'), course);
    }

    courseForm.reset();
    courseForm.style.display = 'none';
    loadCourses();
  });

  async function loadCourses() {
    coursesList.innerHTML = '';
    const snaps = await getDocs(collection(db, "courses"));
    const t = texts[currentLang];
    snaps.forEach(snap => {
      const d = snap.data();
      if (d.lang !== currentLang) return;

      const card = document.createElement('div');
      card.className = 'course-card';
      card.innerHTML = `
        <img src="${d.image}" alt="Image" onerror="this.style.display='none'">
        <h3>${d.title}</h3>
        <p>${d.description}</p>
        ${(currentUser?.uid === d.uid && currentUserRole === 'teacher') ? `
          <div class="course-actions">
            <button class="edit-btn" onclick="startEdit('${snap.id}');event.stopPropagation();">${t.edit}</button>
            <button class="delete-btn" onclick="deleteCourse('${snap.id}');event.stopPropagation();">${t.del}</button>
          </div>
        ` : ''}
      `;
      card.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') return;
        showModal(d);
      });
      coursesList.appendChild(card);
    });
  }

  window.deleteCourse = async function(id) {
    await deleteDoc(doc(db, 'courses', id));
    loadCourses();
  };

  window.startEdit = async function(id) {
    const snaps = await getDocs(collection(db, 'courses'));
    snaps.forEach(s => {
      if (s.id === id) {
        const d = s.data();
        document.getElementById('courseTitle').value = d.title;
        document.getElementById('courseDescription').value = d.description;
        document.getElementById('courseImage').value = d.image;
        document.getElementById('courseVideo').value = d.video;
        courseForm.dataset.editId = id;
        courseForm.style.display = 'block';
      }
    });
  };

  const modal = document.getElementById("courseModal");
  const modalTitle = document.getElementById("modalTitle");
  const modalDescription = document.getElementById("modalDescription");
  const modalImage = document.getElementById("modalImage");
  const modalVideo = document.getElementById("modalVideo");
  const closeModal = document.getElementById("closeModal");

  closeModal.addEventListener('click', () => {
    modal.style.display = "none";
    modalVideo.src = "";
  });

  window.onclick = function(event) {
    if (event.target === modal) {
      modal.style.display = "none";
      modalVideo.src = "";
    }
  };

  function makeEmbed(videoUrl) {
    if (!videoUrl) return "";
    if (videoUrl.includes("watch?v=")) {
      return videoUrl.replace("watch?v=", "embed/");
    } else if (videoUrl.includes("youtu.be")) {
      const id = videoUrl.split("youtu.be/")[1].split("?")[0];
      return `https://www.youtube.com/embed/${id}`;
    }
    return videoUrl;
  }

  function showModal(data) {
    modalTitle.textContent = data.title;
    modalDescription.textContent = data.description;
    modalImage.src = data.image;
    modalVideo.src = makeEmbed(data.video);
    modal.style.display = "flex";
  }
</script>

</body>
</html>
